{#-----------------------------------------------#}
{# CONTEXT:                                      #}
{# #}
{#-----------------------------------------------#}
{% extends "chair/base/_chair_preview_base.html" %}
{% load bootstrap4 %}
{% load submission_extras %}

{% block title %}
  Compose message
{% endblock %}

{% block header %}
  {% include 'user_site/components/navigation.html' with active='' %}
{% endblock %}

{% block css %}
<link href="//cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
<style>
#message-editor .ql-editor {
  padding: 12px 15px !important;
}
</style>
{% endblock %}

{% block viewPanelTitle %}
{{ msg.subject }}
{% endblock %}

{% block viewPanelBody %}
  <div>
    <p class="dccn-text-smaller">
      <span class="font-weight-bold">Sender:</span>
      {{ msg.sent_by.profile.get_full_name }}
    </p>
    <p class="dccn-text-smaller">
      <span class="font-weight-bold">To:</span>
      {{ msg.user_to.profile.get_full_name }}
    </p>
    <p class="dccn-text-smaller">
      <span class="font-weight-bold">Sent at:</span>
      {{ msg.sent_at|date:"d.m.Y G:i" }}
    </p>
    <p class="dccn-text-smaller">
      <span class="font-weight-bold">Message type:</span>
      {{ msg.message.message_type }}
    </p>

    <hr>

    <div class="dccn-embed-html" data-source="{% url 'chair_mail:message-instance-details' conf_pk=conference.pk msg_pk=msg.pk %}" data-attr="text_html">
      <div class="dccn-embed-box"></div>
    </div>
  </div>

  <hr>

  <div class="d-flex">
    <a href="{{ next }}" class="btn btn-sm btn-outline-primary">Close</a>
    <button class="btn btn-sm btn-info ml-2" data-toggle="modal" data-target="#templateModal">Show template</button>
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="templateModal" data-source="{% url 'chair_mail:message-details' conf_pk=conference.pk msg_pk=msg.message.pk %}">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Message template</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="text" name="template_subject" class="form-control" id="templateSubject" readonly>
          <div id="templateEditor" class="mt-2 border px-3 py-2 bg-light">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
$(document).ready(function () {

(function ($) {
  $.fn.dccnEmbedHtml = function () {
    const elem = this;
    const box = this.find('.dccn-embed-box');
    $.get(elem.attr('data-source'), function (data) {
      box.html($.parseHTML(data[elem.attr('data-attr')]));
    });
  };

  //////////////////////////////
  // Associating the plugins
  $('.dccn-embed-html').dccnEmbedHtml();

  //////////////////////////////
  // Load template on modal show event:
  $('#templateModal').on('show.bs.modal', function () {
    const modal = $(this);
    $.get($(this).attr('data-source'), function (data) {
      const subject = modal.find('#templateSubject');
      const editor = modal.find('#templateEditor');
      subject.val(data.subject);
      editor.html(data.body_html)
    });
  });


  //////////////////////////////
  // Attach quill in read-only mode:
  const quill = new Quill('#templateEditor', {
    theme: 'bubble',
  });


}(jQuery));

});
</script>
{% endblock %}
