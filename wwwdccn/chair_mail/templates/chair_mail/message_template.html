{% extends 'chair_mail/_base.html' %}
{% load static %}
{% load bootstrap4 %}

{% block css %}
<link rel="stylesheet" href="{% static 'codemirror/lib/codemirror.css' %}">
<link rel="stylesheet" href="{% static 'codemirror/theme/monokai.css' %}">
<link rel="stylesheet" href="{% static 'codemirror/addon/scroll/simplescrollbars.css' %}">
<style>
#htmlFormGroup .CodeMirror {
  height: 60vh;
}
#plainTextFormGroup .CodeMirror {
  height: 20vh;
}
</style>
{% endblock %}


{#---------------------------------------------------------------------------#}
{# Main content                                                              #}
{#---------------------------------------------------------------------------#}
{% block mainPanelContent %}
<div class="dccn-panel-body">
{% include 'chair_mail/components/navigation.html' with active='template' %}

  {% bootstrap_messages %}

  <div class="container my-3 px-0" style="margin: 15px 0 !important; max-width: none !important;">

    <form action="{% url 'chair_mail:message-template' conf_pk=conference.pk %}" method="POST" id="templateForm" class="mt-3 w-100">
      {% csrf_token %}

      <div class="form-group row" id="htmlFormGroup">
        <div class="col-12 col-lg-6">
          <div class="mr-0 mr-lg-2">
            {% bootstrap_field form.text_html %}
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="ml-0 ml-lg-2">
            <label class="form-label">Preview:</label>
            <div class="border">
              <div id="preview">{{ template.text_html|safe }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group" id="plainTextFormGroup">
        {% bootstrap_field form.text_plain %}
      </div>

    </form>

    <div class="d-flex my-3">
      <button type="submit" class="btn btn-primary" form="templateForm">Save</button>
      <button type="button" class="btn btn-outline-info ml-auto" id="sendMeSampleBtn"
              data-action="{% url 'chair_mail:send-template-test-message' conf_pk=conference.pk %}">
        Send me test message
      </button>
    </div>

    {% include 'chair_mail/components/template_help.html' %}

    <hr>

    <div class="d-flex mt-4">
      <div class="dccn-text-smaller text-muted">
        Template created by {{ template.created_by.profile.get_full_name }}.
        <br>
        Created at {{ template.created_at }}
        <br>
        Last updated at {{ template.updated_at }}
      </div>
      <button class="btn btn-outline-danger ml-auto align-self-start" data-toggle="modal" data-target="#confirmTemplateResetModal">Reset template</button>
    </div>

  </div>
</div>

{#------------------ #}
{# **** MODALS ***** #}
{#------------------ #}
{% include 'chair_mail/components/confirm_template_reset_modal.html' %}

{% endblock %}


{% block script %}
<script src="{% static 'codemirror/lib/codemirror.js' %}"></script>
<script src="{% static 'codemirror/mode/htmlmixed/htmlmixed.js' %}"></script>
<script src="{% static 'codemirror/addon/scroll/simplescrollbars.js' %}"></script>
<script src="{% static 'scripts/require.js' %}" data-main="{% static '' %}"></script>
<script>
$(document).ready(function () {
  const previewDiv = $('#preview');

  requirejs([
    'codemirror/lib/codemirror', 'codemirror/mode/htmlmixed/htmlmixed', 'codemirror/addon/scroll/simplescrollbars'
  ], function (CodeMirror) {
    const htmlEditor = CodeMirror.fromTextArea(document.getElementById('id_text_html'), {
      lineNumbers: true,
      mode: 'htmlmixed',
      theme: 'monokai',
      scrollbarStyle: "simple",
      lineWrapping: true,
    });

    htmlEditor.on('change', function (cm) {
      previewDiv.html(cm.getValue());
    });

    CodeMirror.fromTextArea(document.getElementById('id_text_plain'), {
      lineNumbers: true,
      theme: 'monokai',
      scrollbarStyle: "simple",
      lineWrapping: true,
    });
  });

  $('#sendMeSampleBtn').on('click', function () {
    const action = $(this).attr('data-action');
    const data = $('#templateForm').serialize();
    console.log(data);
    $.post(action, data);
  });
});
</script>
{% endblock %}
